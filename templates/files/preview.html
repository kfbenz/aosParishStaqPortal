{% extends "base.html" %}

{% block title %}{{ filename }} - Preview - ParishStaq Portal{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/files">Files</a></li>
        <li class="breadcrumb-item"><a href="/files/browse/{{ folder }}">{{ folder }}</a></li>
        <li class="breadcrumb-item active">{{ filename }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-file-earmark-text"></i> 
        {{ filename }}
    </h2>
    <div>
        <a href="/files/download/{{ folder }}/{{ filename }}" class="btn btn-primary">
            <i class="bi bi-download"></i> Download
        </a>
        <a href="/files/browse/{{ folder }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- File Info -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-4"><strong>Size:</strong></div>
                    <div class="col-sm-8">{{ size }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>Modified:</strong></div>
                    <div class="col-sm-8">{{ modified.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>Location:</strong></div>
                    <div class="col-sm-8">{{ folder }}/{{ filename }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Content Preview -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Preview</span>
        {% if preview_type == 'csv' %}
        <span class="badge bg-success">CSV</span>
        {% elif preview_type == 'json' %}
        <span class="badge bg-info">JSON</span>
        {% elif preview_type == 'html' %}
        <span class="badge bg-warning">HTML</span>
        {% else %}
        <span class="badge bg-secondary">Text</span>
        {% endif %}
    </div>
    <div class="card-body p-0">
        {% if preview_type == 'csv' %}
        <div class="table-responsive" style="max-height: 600px; overflow: auto;">
            <table class="table table-sm table-striped table-bordered mb-0" id="csvTable">
                <!-- Will be populated by JavaScript -->
            </table>
        </div>
        <script>
            const csvContent = {{ content | tojson }};
            const lines = csvContent.split('\n');
            const table = document.getElementById('csvTable');
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                const row = document.createElement('tr');
                const cells = line.split(',');
                
                cells.forEach(cell => {
                    const td = document.createElement(index === 0 ? 'th' : 'td');
                    td.textContent = cell.replace(/^"|"$/g, '').trim();
                    if (index === 0) td.className = 'table-dark';
                    row.appendChild(td);
                });
                
                if (index === 0) {
                    const thead = document.createElement('thead');
                    thead.appendChild(row);
                    table.appendChild(thead);
                } else {
                    let tbody = table.querySelector('tbody');
                    if (!tbody) {
                        tbody = document.createElement('tbody');
                        table.appendChild(tbody);
                    }
                    tbody.appendChild(row);
                }
            });
        </script>
        
        {% elif preview_type == 'json' %}
        <pre class="m-0 p-3" style="max-height: 600px; overflow: auto; background: #f8f9fa;"><code id="jsonContent"></code></pre>
        <script>
            try {
                const jsonContent = {{ content | tojson }};
                const parsed = JSON.parse(jsonContent);
                document.getElementById('jsonContent').textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                document.getElementById('jsonContent').textContent = {{ content | tojson }};
            }
        </script>
        
        {% elif preview_type == 'html' %}
        <div class="p-3">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#htmlSource">Source</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#htmlRender">Rendered</button>
                </li>
            </ul>
            <div class="tab-content mt-2">
                <div class="tab-pane fade show active" id="htmlSource">
                    <pre class="m-0 p-3" style="max-height: 500px; overflow: auto; background: #f8f9fa;"><code>{{ content }}</code></pre>
                </div>
                <div class="tab-pane fade" id="htmlRender">
                    <iframe srcdoc="{{ content | e }}" style="width: 100%; height: 500px; border: 1px solid #ddd;"></iframe>
                </div>
            </div>
        </div>
        
        {% else %}
        <pre class="m-0 p-3" style="max-height: 600px; overflow: auto; background: #f8f9fa; white-space: pre-wrap;">{{ content }}</pre>
        {% endif %}
    </div>
</div>

<style>
#csvTable th, #csvTable td {
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
}
pre {
    font-size: 0.85rem;
}
</style>
{% endblock %}
